var MakeGraphic = {
		
		
		connection: FactoryConnection.getConnection(),
		
		getDataForGraphic: function(dateS, dateE, cat) {
		$.ajax({
			url: MakeGraphic.connection + '/ServletRelatory',
			data:{ dateStart: dateS , dateEnd: dateE, category: cat},
			success: function(jsonString){
				var json = JSON.parse(jsonString);
				var jsonGraphic = JSON.parse(json[0]);
				var jsonTable = JSON.parse(json[1]);
			    MakeGraphic.drawChart(jsonGraphic);
			    MakeGraphic.createTable(jsonTable);
			}
		});
	},
	
	 getData: function(json){
        var list = [];
        for(var i =0;i<Object.keys(json).length; i++){
            list.push(json[i].value);
           
        }
      //  alert('data : ' +list.toString());
       return list; 
       
    },
    
    
     getCategory: function(json){
        var list = [];
        for(var i =0;i<Object.keys(json).length; i++){
            list.push(json[i].name);
           //alert(json[i].name);
        }
       // alert('categories: ' + list.toString());
        return list; 
    },
	
    
    
    drawChart: function(json) {    
        // Create the chart
    	alert(json);
        $('#chart_div').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Relatório de Gastos'
            },
            subtitle: {
                text: 'Clique nas colunas para ver detalhes'
            },
            xAxis: {
                type: 'category',
                categories : MakeGraphic.getCategory(json)
            },
            yAxis: {
                title: {
                    text: 'Gasto Total'
                }

            },
            legend: {
                enabled: false
            },
            plotOptions: {
                series: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function () {
                               // alert('Category: ' + this.category + ', value: ' + this.y);
                                MakeGraphic.getDataForDetailedGraphic(this.category);
                            }
                        }
                    }
                }
            },

            tooltip: {
                headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                pointFormat: '<span style="color:{point.color}">{point.name}</span> <b>R$ {point.y:.2f}</b><br/>'
            },

            series: [{
                name: "Valor",
                colorByPoint: true,
                data: MakeGraphic.getData(json)
            }],


            });
    },
    
    



    drawDetailedChart: function(json) {
       
        $('#chart_div').highcharts({
            chart: {
                type: 'column'
            },
            title: {
                text: 'Relatório de Gastos Detalhados: ' + MakeGraphic.getSubcategory(json)
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                type: 'category',
                categories : MakeGraphic.getDates(json)
            },
            yAxis: {
                title: {
                    text: 'Gasto Total'
                }

            },
            legend: {
                enabled: false
            },

            tooltip: {
                headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                pointFormat: '<span style="color:{point.color}">{point.name}</span> <b>R$ {point.y:.2f}</b><br/>'
            },

            series: [{
                name: "Valor",
                colorByPoint: true,
                data: MakeGraphic.getData(json)
            }],


          });
    },

    
    getSubcategory: function(json) {
		//alert(JSON.stringify(json));
		return json[0].subcategory;
	},
	

    getDates: function(json) {
    	var list = [];
        for(var i =0;i<Object.keys(json).length; i++){
            list.push(MakeGraphic.formatDate(json[i].date));
        }
        return list; 
	},
	
	
    getDataForDetailedGraphic: function(subcategory) {
    	var dateS = new Date();
        var dateE = new Date();
        dateS = $('#dateStart').val();
        dateE = $('#dateEnd').val();
        
        var dateStart = Relatorio.formatDate(dateS);
        var dateEnd =  Relatorio.formatDate(dateE);

    	
        var ajax = ajaxInit();
        if (ajax) {
            var url = FactoryConnection.getConnection() + '/ServletDetailedGraphic?dateStart='
                    + dateStart + '&dateEnd=' + dateEnd + '&subcategory=' + subcategory;
            ajax.open('GET', url, true);
            ajax.send();
        }
        ajax.onreadystatechange = function() {
            if (ajax.readyState == 4 && ajax.status == 200) {
                var jsonString = ajax.responseText;
                var json = JSON.parse(jsonString);
                MakeGraphic.drawDetailedChart(json);
                MakeGraphic.createTable(json);
            }
        };
    },

    
     formatDate: function(input){
        var p = input.split(/\D/g);
        var result = [p[2],p[1],p[0]].join("/");   

        return result;
    },    
    
   
    getDataForTable: function(json) {
    	var result = "";
    	for(var i =0;i < json.length; i++){
    		result += '{recid:' + i + ', categoria: "' + json[i].category + '", description: "' + json[i].description + '", valor: ' + json[i].value + ', data: "' + json[i].date  +'"}';
    		console.log(result+"\n\n" + json.length);
    		if(i< (json.length -1)){
    			result += ',\n';
    		}
    	}
    	return result;
	},
	
	
    createTable: function(json) {
    	//get data to put in the table
    	alert(json);
    	var data = MakeGraphic.getDataForTable(json);
    	
	    $(function () {    
	        $('#table').w2grid({ 
	            name: 'table', 
	            show: { 
	                toolbar: true,
	                footer: true,
	                toolbarAdd: true,
	                toolbarDelete: true,
	                toolbarSave: true,
	                toolbarEdit: true
	            },
	            searches: [                
	                { field: 'lname', caption: 'Last Name', type: 'text' },
	                { field: 'fname', caption: 'First Name', type: 'text' },
	                { field: 'email', caption: 'Email', type: 'text' },
	                { field: 'sdate', caption: 'Start Date', type: 'Date' }
	            ],
	            columns: [                
	                { field: 'recid', caption: 'ID', size: '50px', sortable: true, attr: 'align=center' },
	                { field: 'lname', caption: 'Last Name', size: '30%', sortable: true },
	                { field: 'fname', caption: 'First Name', size: '30%', sortable: true },
	                { field: 'email', caption: 'Email', size: '40%' },
	                { field: 'sdate', caption: 'Start Date', size: '120px' },
	            ],
	            onAdd: function (event) {
	                w2alert('add');
	            },
	            onEdit: function (event) {
	                w2alert('edit');
	            },
	            onDelete: function (event) {
	                console.log('delete has default behaviour');
	            },
	            onSubmit: function (event) {
	                w2alert('save');
	            },
	            records: [
	                /*{ recid: 1, fname: 'Jane', lname: 'Doe', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 2, fname: 'Stuart', lname: 'Motzart', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 3, fname: 'Jin', lname: 'Franson', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 4, fname: 'Susan', lname: 'Ottie', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 5, fname: 'Kelly', lname: 'Silver', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 6, fname: 'Francis', lname: 'Gatos', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 7, fname: 'Mark', lname: 'Welldo', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 8, fname: 'Thomas', lname: 'Bahh', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 9, fname: 'Sergei', lname: 'Rachmaninov', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 20, fname: 'Jill', lname: 'Doe', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 21, fname: 'Frank', lname: 'Motzart', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 22, fname: 'Peter', lname: 'Franson', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 23, fname: 'Andrew', lname: 'Ottie', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 24, fname: 'Manny', lname: 'Silver', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 25, fname: 'Ben', lname: 'Gatos', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 26, fname: 'Doer', lname: 'Welldo', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 27, fname: 'Shashi', lname: 'Bahh', email: 'jdoe@gmail.com', sdate: '4/3/2012' },
	                { recid: 28, fname: 'Av', lname: 'Rachmaninov', email: 'jdoe@gmail.com', sdate: '4/3/2012' }
	                */
	               // data
	                {recid:0, categoria: "undefined", description: "teste2", valor: 300, data: "out 20, 2015"},{recid:1, categoria: "undefined", description: "teste", valor: 200, data: "out 23, 2015"},{recid:2, categoria: "undefined", description: "foi pra sjc", valor: 300, data: "out 25, 2015"}
	            ]
	        });
	    
	    });
    }
};
